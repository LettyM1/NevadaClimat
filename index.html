# Trier les mois dans l'ordre chronologique avec des abréviations manuelles
climat_long$mois <- factor(climat_long$mois, levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                                        "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))


# Génération du graphique avec textes pour les infobulles
graph_facet_mois <- climat_long %>%
  mutate(
    text = case_when(
      paramètre %in% c("precipitation", "neige") ~ paste0("Période : ", periode, "<br>", 
                                                          "Lieu : ", lieu, "<br>",
                                                          "Mois : ", mois, "<br>",
                                                          "Type : ", paramètre, "<br>",
                                                          "Valeur : ", valeur, " mm"),
      paramètre %in% c("Tmax", "Tmoyen", "Tmin") ~ paste0("Période : ", periode, "<br>", 
                                                          "Lieu : ", lieu, "<br>",
                                                          "Mois : ", mois, "<br>",
                                                          "Type : ", paramètre, "<br>",
                                                          "Valeur : ", valeur, " °C"),
      TRUE ~ NA_character_
    )
  ) %>%
  
  ggplot() +
  
  # précipitations
  geom_col(
    data = ~filter(.x, paramètre %in% c("precipitation", "neige")),
    aes(x = periode, y = valeur, fill = paramètre, text = text),
    width = 0.9
  ) +

  # lignes température
  geom_line(
    data = ~filter(.x, paramètre %in% c("Tmax", "Tmoyen", "Tmin")),
    aes(x = periode, y = (valeur + 15) * 20 / 50, group = interaction(lieu, paramètre), color = paramètre),
    linewidth = 1
  ) +

  # points température avec contour
  geom_point(
    data = ~filter(.x, paramètre %in% c("Tmax", "Tmoyen", "Tmin")),
    aes(x = periode, y = (valeur + 15) * 20 / 50, fill = paramètre, color = paramètre, text = text),
    shape = 21, size = 0.5, stroke = 0
  ) +

  scale_fill_manual(
    values = c("precipitation" = "#66c2a5", "neige" = "#a6cee3"),
    name = NULL
  ) +
  scale_color_manual(
    values = c("Tmax" = "red", "Tmoyen" = "orange", "Tmin" = "blue"),
    name = NULL
  ) +

  # échelles des y
  scale_y_continuous(
    name = "Précipitations moyennes (mm)",
    limits = c(0, 20),
    sec.axis = sec_axis(~ . * 50 / 20 - 15, name = "Température (C°)", breaks = seq(-15, 35, by = 5))
  ) +
  
  # échelle des x
  scale_x_discrete(labels = function(x) sub("^.*([0-9]{2})-[0-9]{4}$", "\\1", x)) +

  # affichage du facet_grid
  facet_grid(lieu ~ mois, switch = "x") +

  # titres
  labs(
    title = "Climat moyen mensuel : précipitations et températures",
    x = "",
    y = "Précipitations moyennes (mm)"
  ) +

  # thème
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7, color = "black"), # étiquettes x
    panel.grid.major.x = element_blank(),
    #je suis obligé de supprimer la légende sinon plotly me fait 1 légende par valeur...
    # legend.position = "none",
    legend.position = "bottom", # légende en bas
    legend.box = "horizontal",  # les deux légendes se suivent
    # legend.title = element_text(size = 10, face = "bold"),
    # legend.text = element_text(size = 9),
    # Titres des facettes (mois et lieu)
    strip.placement = "outside", # place les titres à l'extérieur
    strip.text.x = element_text(size = 14, face = "bold", color = "darkblue"),  # mois
    strip.text.y = element_text(size = 14, face = "bold", color = "darkgreen", # lieu
                                hjust = 0.5, margin = margin(t = 0, r = 0, b = 0, l = 20)), # position lieu
    # mettre le titre des lieux à droite de l'étiquette secondaire
    strip.text.y.left = element_text(angle = 0, hjust = 0.5), # à gauche de l'axe y secondaire
    axis.text.y.right = element_text(hjust = 0), # colle les étiquettes au graphe
    axis.title.y.right = element_text(
      margin = margin(l = -5),  # petit espace pour coller au graphe
      angle = -90,
      hjust = 0.5,
      vjust = -9 ),
    plot.margin = margin(t = 10, r = 40, b = 10, l = 10)  # augmente l’espace à droite
  )

# affichage statique
print(graph_facet_mois)

# Affichage interactif avec Plotly

# ggplotly(graph_facet_mois, tooltip = "text") %>%
#   layout(legend = list(orientation = "h", x = 0.5, xanchor = "center"))
